# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Service definitions for Druid's dependencies: ZooKeeper, MySQL, and Kafka.
# All tests need ZK and MySQL, ingestion tasks may need Kafka.
#
# These services use "official" images from the project or other sources.
# Some amount of fiddling is needed to map them into configuration which
# Druid requires.

services:

  # Uses the official Zookeeper image
  # See https://hub.docker.com/_/zookeeper
  zookeeper:
    image: zookeeper:${ZK_VERSION}
    container_name: zookeeper
    networks:
      druid-it-net:
        ipv4_address: 172.172.172.4
    ports:
        - 2181:2181
    volumes:
      - ${SHARED_DIR}/logs:/logs
    environment:
       ZOO_LOG4J_PROP: INFO,ROLLINGFILE

  # Uses the Bitnami Kafka image
  # See https://hub.docker.com/r/bitnami/kafka/
  kafka:
    image: bitnami/kafka:${KAFKA_VERSION}
    container_name: kafka
    ports:
      - 9092:9092
      - 9093:9093
    networks:
      druid-it-net:
        ipv4_address: 172.172.172.2
    volumes:
      - ${SHARED_DIR}/kafka:/bitnami/kafka
    environment:
      # This is the default: making it explicit
      KAFKA_CFG_ZOOKEEPER_CONNECT: zookeeper:2181
      # Plaintext is disabled by default
      ALLOW_PLAINTEXT_LISTENER: "yes"
      # Adapted from base-setup.sh and Bitnami docs
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT"
      KAFKA_CFG_LISTENERS: "INTERNAL://:9092,EXTERNAL://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "INTERNAL://kafka:9092,EXTERNAL://localhost:9093"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: INTERNAL
    depends_on:
      - zookeeper

  # Uses the official MySQL image
  # See https://hub.docker.com/_/mysql
  # The image will intialize the user and DB upon first start.
  metadata:
    image: mysql:$MYSQL_VERSION
    container_name: metadata
    networks:
      druid-it-net:
        ipv4_address: 172.172.172.3
    ports:
      - 3306:3306
    volumes:
      - ${SHARED_DIR}/db:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: driud
      MYSQL_DATABASE: druid
      MYSQL_USER: druid
      MYSQL_PASSWORD: driud
